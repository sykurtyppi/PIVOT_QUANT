<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Pivot Analysis Platform - Real Data</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --primary-bg: #1a1d29;
            --secondary-bg: #252836;
            --accent-bg: #2d3142;
            --border-color: #3a3d4a;
            --primary-text: #ffffff;
            --secondary-text: #b8bcc8;
            --accent-blue: #2563eb;
            --accent-green: #059669;
            --accent-red: #dc2626;
            --accent-orange: #ea580c;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--primary-bg);
            color: var(--primary-text);
            line-height: 1.5;
            font-size: 14px;
        }

        .platform-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .platform-header {
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        .platform-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-text);
        }

        .platform-subtitle {
            font-size: 11px;
            color: var(--secondary-text);
            font-weight: 400;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .symbol-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .symbol-input {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px 12px;
            color: var(--primary-text);
            font-size: 13px;
            width: 80px;
            text-transform: uppercase;
        }

        .symbol-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .load-btn {
            background: var(--accent-blue);
            border: none;
            border-radius: 4px;
            color: white;
            padding: 6px 16px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .load-btn:hover { background: #1d4ed8; }
        .load-btn:disabled { background: #374151; cursor: not-allowed; }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--secondary-text);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--error);
        }

        .status-dot.connected { background: var(--success); }
        .status-dot.loading { background: var(--warning); animation: pulse 1.5s infinite; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Navigation */
        .navigation-tabs {
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            padding: 0 24px;
        }

        .nav-tab {
            background: none;
            border: none;
            color: var(--secondary-text);
            padding: 12px 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav-tab.active {
            color: var(--primary-text);
            border-bottom-color: var(--accent-blue);
        }

        .nav-tab:hover:not(.active) { color: var(--primary-text); }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .tab-panel {
            display: none;
            width: 100%;
            height: 100%;
        }

        .tab-panel.active { display: flex; }

        /* Overview Layout */
        .overview-layout {
            display: grid;
            grid-template-columns: 320px 1fr 280px;
            gap: 1px;
            background: var(--border-color);
            height: 100%;
        }

        .market-data-panel,
        .pivot-levels-panel,
        .analysis-panel {
            background: var(--primary-bg);
            padding: 20px;
            overflow-y: auto;
        }

        .panel-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary-text);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        /* Market Data Panel */
        .market-data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .data-item {
            background: var(--secondary-bg);
            border-radius: 6px;
            padding: 12px;
            border: 1px solid var(--border-color);
        }

        .data-label {
            font-size: 11px;
            color: var(--secondary-text);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-text);
        }

        .data-change {
            font-size: 11px;
            margin-top: 2px;
        }

        .data-change.positive { color: var(--success); }
        .data-change.negative { color: var(--error); }

        /* Pivot Levels Table */
        .pivot-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--secondary-bg);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .pivot-table th {
            background: var(--accent-bg);
            padding: 10px 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--secondary-text);
            text-align: left;
        }

        .pivot-table td {
            padding: 10px 12px;
            border-top: 1px solid var(--border-color);
            font-size: 13px;
        }

        .level-label { font-weight: 600; }
        .level-label.resistance { color: var(--accent-red); }
        .level-label.support { color: var(--success); }
        .level-label.pivot { color: var(--accent-orange); }

        .price-value {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-weight: 500;
        }

        .distance-value {
            font-size: 12px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        }

        .distance-value.above { color: var(--success); }
        .distance-value.below { color: var(--error); }

        /* Chart Panel */
        .chart-layout {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: var(--primary-bg);
        }

        .chart-header {
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-text);
        }

        .chart-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .timeframe-btn {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--secondary-text);
            padding: 4px 12px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .timeframe-btn.active,
        .timeframe-btn:hover {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        #chartContainer {
            flex: 1;
            background: var(--secondary-bg);
        }

        /* Analysis Panel */
        .analysis-section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary-text);
            margin-bottom: 12px;
        }

        .metric-item {
            background: var(--secondary-bg);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
        }

        .metric-label {
            font-size: 11px;
            color: var(--secondary-text);
            margin-bottom: 2px;
        }

        .metric-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-text);
        }

        /* Loading States */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 29, 41, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: var(--error);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            margin: 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="platform-container">
        <!-- Header -->
        <header class="platform-header">
            <div>
                <div class="platform-title">Professional Pivot Analysis Platform - Real Market Data</div>
                <div class="platform-subtitle">Live market data with institutional-grade pivot analysis</div>
            </div>
            <div class="header-controls">
                <div class="symbol-selector">
                    <label for="symbol-input" style="font-size: 12px; color: var(--secondary-text);">Symbol:</label>
                    <input type="text" id="symbol-input" class="symbol-input" value="SPY" maxlength="6">
                    <button id="load-data-btn" class="load-btn">Load Data</button>
                </div>
                <div class="status-indicator">
                    <div id="status-dot" class="status-dot"></div>
                    <span id="status-text">Ready</span>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="navigation-tabs">
            <button class="nav-tab active" data-tab="overview">Market Overview</button>
            <button class="nav-tab" data-tab="chart">Chart Analysis</button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Overview Tab -->
            <div id="overview-panel" class="tab-panel active">
                <div class="overview-layout">
                    <!-- Market Data Panel -->
                    <div class="market-data-panel">
                        <div class="panel-header">Real Market Data</div>
                        <div class="market-data-grid">
                            <div class="data-item">
                                <div class="data-label">Open</div>
                                <div class="data-value" id="open-value">--</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">High</div>
                                <div class="data-value" id="high-value">--</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Low</div>
                                <div class="data-value" id="low-value">--</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Close</div>
                                <div class="data-value" id="close-value">--</div>
                                <div class="data-change" id="close-change">--</div>
                            </div>
                        </div>

                        <div class="data-item" style="margin-bottom: 20px;">
                            <div class="data-label">Current Price</div>
                            <div class="data-value" id="current-value">--</div>
                            <div class="data-change" id="current-change">--</div>
                        </div>

                        <div class="data-item" style="margin-bottom: 20px;">
                            <div class="data-label">Volume</div>
                            <div class="data-value" id="volume-value" style="font-size: 12px;">--</div>
                        </div>

                        <div class="data-item">
                            <div class="data-label">Last Updated</div>
                            <div class="data-value" id="last-updated" style="font-size: 12px;">--</div>
                        </div>
                    </div>

                    <!-- Pivot Levels Panel -->
                    <div class="pivot-levels-panel">
                        <div class="panel-header">
                            <span id="pivot-levels-title">Professional Pivot Levels</span>
                            <div style="font-size: 10px; color: var(--secondary-text); margin-top: 4px;">
                                ATR: <span id="atr-value">--</span> | Method: <span id="method-display">Standard</span>
                            </div>
                        </div>
                        <table class="pivot-table">
                            <thead>
                                <tr>
                                    <th>Level</th>
                                    <th>Price</th>
                                    <th>Distance</th>
                                </tr>
                            </thead>
                            <tbody id="pivot-table-body">
                                <tr>
                                    <td colspan="3" style="text-align: center; color: var(--secondary-text); padding: 20px;">
                                        Loading real market data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Analysis Panel -->
                    <div class="analysis-panel">
                        <div class="panel-header">Market Analysis</div>

                        <div class="analysis-section">
                            <div class="section-title">Market Regime</div>
                            <div class="metric-item">
                                <div class="metric-label">Trend</div>
                                <div class="metric-value" id="trend-value">--</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Volatility</div>
                                <div class="metric-value" id="volatility-value">--</div>
                            </div>
                        </div>

                        <div class="analysis-section">
                            <div class="section-title">Key Levels</div>
                            <div class="metric-item">
                                <div class="metric-label">Nearest Resistance</div>
                                <div class="metric-value" id="nearest-resistance">--</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Nearest Support</div>
                                <div class="metric-value" id="nearest-support">--</div>
                            </div>
                        </div>

                        <div class="analysis-section">
                            <div class="section-title">Statistics</div>
                            <div class="metric-item">
                                <div class="metric-label">Data Points</div>
                                <div class="metric-value" id="data-points">--</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Data Source</div>
                                <div class="metric-value" id="data-source">Yahoo Finance</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart Tab -->
            <div id="chart-panel" class="tab-panel">
                <div class="chart-layout">
                    <div class="chart-header">
                        <div class="chart-title">Real Price Chart with Pivot Levels</div>
                        <div class="chart-controls">
                            <select id="pivot-type-select" class="timeframe-btn" style="margin-right: 12px;">
                                <option value="standard">Standard Pivots</option>
                                <option value="fibonacci">Fibonacci Pivots</option>
                                <option value="camarilla">Camarilla Pivots</option>
                            </select>
                        </div>
                    </div>
                    <div id="chartContainer"></div>
                </div>
            </div>
        </main>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <script>
        class RealDataPivotPlatform {
            constructor() {
                this.chart = null;
                this.candleSeries = null;
                this.pivotLines = [];
                this.currentData = null;
                this.currentPivotType = 'standard';
                this.currentSymbol = 'SPY';
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setStatus('loading', 'Initializing...');

                // Load real SPY data immediately
                setTimeout(() => {
                    this.loadRealMarketData();
                }, 500);
            }

            setupEventListeners() {
                // Tab switching
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
                });

                // Data loading
                document.getElementById('load-data-btn').addEventListener('click', () => this.loadRealMarketData());
                document.getElementById('symbol-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.loadRealMarketData();
                });

                // Pivot type selector
                document.getElementById('pivot-type-select').addEventListener('change', (e) => {
                    this.currentPivotType = e.target.value;
                    if (this.currentData) {
                        this.calculateAndDisplayPivots();
                        this.updateChart();
                    }
                });
            }

            async loadRealMarketData() {
                const symbol = document.getElementById('symbol-input').value.toUpperCase() || 'SPY';
                this.currentSymbol = symbol;

                this.setStatus('loading', `Loading ${symbol} data...`);
                this.showLoading(true);

                try {
                    const data = await this.fetchRealMarketData(symbol);
                    this.currentData = data;

                    this.updateMarketDataDisplay(data);
                    this.calculateAndDisplayPivots();
                    this.updateAnalysis(data);

                    this.setStatus('connected', `${symbol} data loaded successfully`);
                    console.log('Loaded real market data:', data);

                } catch (error) {
                    console.error('Failed to load market data:', error);
                    this.setStatus('error', 'Failed to load real data');
                    this.showErrorMessage(`Failed to load ${symbol} data: ${error.message}`);
                } finally {
                    this.showLoading(false);
                }
            }

            async fetchRealMarketData(symbol) {
                // Try multiple endpoints for real Yahoo Finance data
                const endpoints = [
                    `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=1mo&interval=1d`,
                    `https://query2.finance.yahoo.com/v8/finance/chart/${symbol}?range=1mo&interval=1d`,
                    `https://cors-anywhere.herokuapp.com/https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=1mo&interval=1d`
                ];

                let lastError;

                for (const url of endpoints) {
                    try {
                        console.log(`Trying to fetch from: ${url}`);

                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'User-Agent': 'Mozilla/5.0 (compatible; PivotAnalyzer/1.0)'
                            }
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const data = await response.json();
                        console.log('Raw API response:', data);

                        if (data.chart?.result?.[0]) {
                            return this.processYahooFinanceData(data.chart.result[0]);
                        } else {
                            throw new Error('Invalid data structure received');
                        }

                    } catch (error) {
                        console.warn(`Failed to fetch from ${url}:`, error);
                        lastError = error;
                        continue;
                    }
                }

                // If all endpoints fail, try a fallback service
                try {
                    console.log('Trying fallback API...');
                    return await this.fetchFromFallbackAPI(symbol);
                } catch (fallbackError) {
                    console.error('Fallback API also failed:', fallbackError);
                    throw new Error(`All data sources failed. Last error: ${lastError?.message || 'Unknown error'}`);
                }
            }

            async fetchFromFallbackAPI(symbol) {
                // Use a CORS proxy service as fallback
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=1mo&interval=1d`)}`;

                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    throw new Error(`Proxy service failed: ${response.status}`);
                }

                const proxyData = await response.json();
                const data = JSON.parse(proxyData.contents);

                if (data.chart?.result?.[0]) {
                    return this.processYahooFinanceData(data.chart.result[0]);
                } else {
                    throw new Error('Invalid data from fallback service');
                }
            }

            processYahooFinanceData(result) {
                console.log('Processing Yahoo Finance data:', result);

                const meta = result.meta;
                const timestamps = result.timestamp;
                const quotes = result.indicators.quote[0];

                if (!timestamps || !quotes) {
                    throw new Error('Missing required data fields');
                }

                // Process candlestick data
                const candles = [];
                for (let i = 0; i < timestamps.length; i++) {
                    if (quotes.open[i] !== null && quotes.high[i] !== null &&
                        quotes.low[i] !== null && quotes.close[i] !== null) {
                        candles.push({
                            time: timestamps[i],
                            open: Number(quotes.open[i].toFixed(2)),
                            high: Number(quotes.high[i].toFixed(2)),
                            low: Number(quotes.low[i].toFixed(2)),
                            close: Number(quotes.close[i].toFixed(2)),
                            volume: quotes.volume[i] || 0
                        });
                    }
                }

                if (candles.length === 0) {
                    throw new Error('No valid candle data available');
                }

                const latest = candles[candles.length - 1];
                const previous = candles.length > 1 ? candles[candles.length - 2] : latest;

                const processedData = {
                    symbol: meta.symbol || symbol,
                    currency: meta.currency || 'USD',
                    currentPrice: meta.regularMarketPrice || latest.close,
                    previousClose: meta.previousClose || previous.close,
                    marketState: meta.marketState || 'UNKNOWN',
                    open: latest.open,
                    high: latest.high,
                    low: latest.low,
                    close: latest.close,
                    volume: latest.volume,
                    candles: candles,
                    lastUpdated: new Date().toLocaleString(),
                    dataSource: 'Yahoo Finance'
                };

                console.log('Processed market data:', processedData);
                return processedData;
            }

            updateMarketDataDisplay(data) {
                const change = data.currentPrice - data.previousClose;
                const changePercent = (change / data.previousClose) * 100;

                // Update OHLC values
                document.getElementById('open-value').textContent = data.open.toFixed(2);
                document.getElementById('high-value').textContent = data.high.toFixed(2);
                document.getElementById('low-value').textContent = data.low.toFixed(2);
                document.getElementById('close-value').textContent = data.close.toFixed(2);
                document.getElementById('current-value').textContent = data.currentPrice.toFixed(2);
                document.getElementById('last-updated').textContent = data.lastUpdated;

                // Format volume
                const volume = data.volume;
                const volumeStr = volume > 1000000 ? `${(volume/1000000).toFixed(1)}M` :
                                volume > 1000 ? `${(volume/1000).toFixed(1)}K` : volume.toString();
                document.getElementById('volume-value').textContent = volumeStr;

                // Update change displays
                const changeText = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)`;
                const changeClass = `data-change ${change >= 0 ? 'positive' : 'negative'}`;

                document.getElementById('close-change').textContent = changeText;
                document.getElementById('close-change').className = changeClass;
                document.getElementById('current-change').textContent = changeText;
                document.getElementById('current-change').className = changeClass;
            }

            calculateAndDisplayPivots() {
                if (!this.currentData) return;

                const { high, low, close } = this.currentData;
                let pivotLevels = {};

                // Calculate based on selected type
                switch (this.currentPivotType) {
                    case 'standard':
                        pivotLevels = this.calculateStandardPivots(high, low, close);
                        break;
                    case 'fibonacci':
                        pivotLevels = this.calculateFibonacciPivots(high, low, close);
                        break;
                    case 'camarilla':
                        pivotLevels = this.calculateCamarillaPivots(high, low, close);
                        break;
                }

                // Calculate ATR
                const atr = this.calculateATR(this.currentData.candles);

                this.updatePivotDisplay(pivotLevels, atr);
                this.currentPivotLevels = pivotLevels;
                this.currentATR = atr;
            }

            calculateStandardPivots(high, low, close) {
                const pivot = (high + low + close) / 3;
                return {
                    R3: 2 * pivot + (high - low),
                    R2: pivot + (high - low),
                    R1: 2 * pivot - low,
                    PP: pivot,
                    S1: 2 * pivot - high,
                    S2: pivot - (high - low),
                    S3: 2 * pivot - (high - low)
                };
            }

            calculateFibonacciPivots(high, low, close) {
                const pivot = (high + low + close) / 3;
                const range = high - low;
                return {
                    'R2': pivot + (range * 0.618),
                    'R1': pivot + (range * 0.382),
                    'PP': pivot,
                    'S1': pivot - (range * 0.382),
                    'S2': pivot - (range * 0.618)
                };
            }

            calculateCamarillaPivots(high, low, close) {
                const range = high - low;
                return {
                    'R4': close + (range * 1.1 / 2),
                    'R3': close + (range * 1.1 / 4),
                    'R2': close + (range * 1.1 / 6),
                    'R1': close + (range * 1.1 / 12),
                    'PP': close,
                    'S1': close - (range * 1.1 / 12),
                    'S2': close - (range * 1.1 / 6),
                    'S3': close - (range * 1.1 / 4),
                    'S4': close - (range * 1.1 / 2)
                };
            }

            calculateATR(candles, period = 14) {
                if (candles.length < period + 1) return null;

                const trueRanges = [];
                for (let i = 1; i < candles.length; i++) {
                    const current = candles[i];
                    const previous = candles[i - 1];

                    const tr1 = current.high - current.low;
                    const tr2 = Math.abs(current.high - previous.close);
                    const tr3 = Math.abs(current.low - previous.close);

                    trueRanges.push(Math.max(tr1, tr2, tr3));
                }

                // Wilder's ATR calculation
                let atr = trueRanges.slice(0, period).reduce((sum, tr) => sum + tr, 0) / period;

                for (let i = period; i < trueRanges.length; i++) {
                    atr = ((atr * (period - 1)) + trueRanges[i]) / period;
                }

                return atr;
            }

            updatePivotDisplay(pivotLevels, atr) {
                const tbody = document.getElementById('pivot-table-body');
                const currentPrice = this.currentData.currentPrice;

                document.getElementById('method-display').textContent =
                    this.currentPivotType.charAt(0).toUpperCase() + this.currentPivotType.slice(1);
                document.getElementById('atr-value').textContent = atr ? atr.toFixed(4) : '--';

                tbody.innerHTML = '';

                // Sort levels by price (highest to lowest)
                const sortedLevels = Object.entries(pivotLevels).sort((a, b) => b[1] - a[1]);

                sortedLevels.forEach(([label, price]) => {
                    const distance = ((price - currentPrice) / currentPrice) * 100;
                    const distanceClass = Math.abs(distance) < 0.5 ? 'at-price' : distance > 0 ? 'above' : 'below';

                    let levelType = 'pivot';
                    if (label.startsWith('R')) levelType = 'resistance';
                    else if (label.startsWith('S')) levelType = 'support';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="level-label ${levelType}">${label}</td>
                        <td class="price-value">${price.toFixed(2)}</td>
                        <td class="distance-value ${distanceClass}">
                            ${distance >= 0 ? '+' : ''}${distance.toFixed(2)}%
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            updateAnalysis(data) {
                // Trend analysis using last 20 candles
                const candles = data.candles.slice(-20);
                const closes = candles.map(c => c.close);
                const sma = closes.reduce((sum, close) => sum + close, 0) / closes.length;

                let trend = 'Neutral';
                if (data.currentPrice > sma * 1.02) trend = 'Bullish';
                else if (data.currentPrice < sma * 0.98) trend = 'Bearish';

                // Volatility calculation
                const returns = [];
                for (let i = 1; i < closes.length; i++) {
                    returns.push(Math.log(closes[i] / closes[i-1]));
                }
                const volatility = Math.sqrt(returns.reduce((sum, ret) => sum + ret * ret, 0) / returns.length) * Math.sqrt(252) * 100;

                // Find nearest levels
                if (this.currentPivotLevels) {
                    const levels = Object.entries(this.currentPivotLevels);
                    const resistanceLevels = levels.filter(([label, value]) => value > data.currentPrice).sort((a, b) => a[1] - b[1]);
                    const supportLevels = levels.filter(([label, value]) => value < data.currentPrice).sort((a, b) => b[1] - a[1]);

                    document.getElementById('nearest-resistance').textContent =
                        resistanceLevels.length > 0 ? `${resistanceLevels[0][0]}: ${resistanceLevels[0][1].toFixed(2)}` : 'None';
                    document.getElementById('nearest-support').textContent =
                        supportLevels.length > 0 ? `${supportLevels[0][0]}: ${supportLevels[0][1].toFixed(2)}` : 'None';
                }

                document.getElementById('trend-value').textContent = trend;
                document.getElementById('volatility-value').textContent = `${volatility.toFixed(1)}%`;
                document.getElementById('data-points').textContent = data.candles.length;
                document.getElementById('data-source').textContent = `${data.dataSource} (${data.currency})`;
            }

            switchTab(tabName) {
                // Update navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Update panels
                document.querySelectorAll('.tab-panel').forEach(panel => {
                    panel.classList.remove('active');
                });
                document.getElementById(`${tabName}-panel`).classList.add('active');

                // Initialize chart if needed
                if (tabName === 'chart' && !this.chart) {
                    this.initializeChart();
                }
            }

            initializeChart() {
                if (!window.LightweightCharts) {
                    console.error('LightweightCharts not loaded');
                    return;
                }

                const container = document.getElementById('chartContainer');
                this.chart = window.LightweightCharts.createChart(container, {
                    width: container.clientWidth,
                    height: container.clientHeight,
                    layout: {
                        background: { color: '#0c111b' },
                        textColor: '#e6e6e6'
                    },
                    grid: {
                        vertLines: { color: 'rgba(255,255,255,0.1)' },
                        horzLines: { color: 'rgba(255,255,255,0.1)' }
                    },
                    timeScale: { timeVisible: true, secondsVisible: false },
                    rightPriceScale: { autoScale: true }
                });

                this.candleSeries = this.chart.addCandlestickSeries({
                    upColor: '#26a69a',
                    downColor: '#ef5350',
                    borderVisible: false,
                    wickUpColor: '#26a69a',
                    wickDownColor: '#ef5350'
                });

                // Load data if available
                if (this.currentData) {
                    this.candleSeries.setData(this.currentData.candles);
                    this.updateChart();
                }

                // Handle resize
                window.addEventListener('resize', () => {
                    this.chart.applyOptions({
                        width: container.clientWidth,
                        height: container.clientHeight
                    });
                });
            }

            updateChart() {
                if (!this.chart || !this.currentPivotLevels) return;

                // Clear existing pivot lines
                this.pivotLines.forEach(line => {
                    try {
                        this.chart.removeSeries(line);
                    } catch (e) {
                        console.warn('Could not remove line:', e);
                    }
                });
                this.pivotLines = [];

                // Add pivot lines
                const currentTime = Math.floor(Date.now() / 1000);

                Object.entries(this.currentPivotLevels).forEach(([label, price]) => {
                    const lineColor = this.getPivotLineColor(label);

                    const pivotLine = this.chart.addLineSeries({
                        color: lineColor,
                        lineWidth: label === 'PP' ? 2 : 1,
                        priceLineVisible: true,
                        lastValueVisible: true,
                        title: `${label}: ${Number(price).toFixed(2)}`
                    });

                    pivotLine.setData([
                        { time: currentTime - (30 * 24 * 3600), value: price },
                        { time: currentTime + (7 * 24 * 3600), value: price }
                    ]);

                    this.pivotLines.push(pivotLine);
                });
            }

            getPivotLineColor(label) {
                const colors = {
                    'R4': '#ef5350', 'R3': '#ef5350', 'R2': '#ef5350', 'R1': '#ef5350',
                    'PP': '#fdd835',
                    'S1': '#66bb6a', 'S2': '#66bb6a', 'S3': '#66bb6a', 'S4': '#66bb6a'
                };
                return colors[label] || '#b0bec5';
            }

            setStatus(type, message) {
                const dot = document.getElementById('status-dot');
                const text = document.getElementById('status-text');
                dot.className = `status-dot ${type}`;
                text.textContent = message;
            }

            showLoading(show) {
                const overlay = document.getElementById('loading-overlay');
                overlay.style.display = show ? 'flex' : 'none';

                const button = document.getElementById('load-data-btn');
                button.disabled = show;
                button.textContent = show ? 'Loading...' : 'Load Data';
            }

            showErrorMessage(message) {
                // Create error message element
                const existingError = document.querySelector('.error-message');
                if (existingError) existingError.remove();

                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;

                document.querySelector('.platform-container').insertBefore(
                    errorDiv,
                    document.querySelector('.main-content')
                );

                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 10000);
            }
        }

        // Initialize platform
        document.addEventListener('DOMContentLoaded', () => {
            window.realDataPivotPlatform = new RealDataPivotPlatform();
        });
    </script>
</body>
</html>