<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional SPY Gamma Flip Calculator</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0c111b 0%, #1a1d29 100%);
            color: #e6e6e6;
            font-family: 'SF Mono', Consolas, 'Monaco', 'Roboto Mono', monospace;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.02);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .header h1 {
            font-size: 28px;
            color: #fdd835;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header p {
            color: #b0bec5;
            font-size: 14px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: rgba(255,255,255,0.02);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .chart-wrapper {
            width: 100%;
            height: 500px;
            margin-top: 15px;
        }

        .sidebar {
            background: rgba(255,255,255,0.02);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            height: fit-content;
        }

        .levels-section {
            margin-bottom: 25px;
        }

        .levels-section h3 {
            color: #fdd835;
            margin-bottom: 15px;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .level-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            border-left: 3px solid;
            font-size: 13px;
        }

        .level-gamma { border-left-color: #9c27b0; background: rgba(156,39,176,0.1); }
        .level-ema21 { border-left-color: #2196f3; background: rgba(33,150,243,0.1); }
        .level-ema9 { border-left-color: #4caf50; background: rgba(76,175,80,0.1); }
        .level-ema50 { border-left-color: #ff9800; background: rgba(255,152,0,0.1); }
        .level-ema9w { border-left-color: #e91e63; background: rgba(233,30,99,0.1); }
        .level-reversal { border-left-color: #f44336; background: rgba(244,67,54,0.1); }

        .level-label {
            font-weight: 600;
            color: #e6e6e6;
        }

        .level-price {
            font-family: monospace;
            font-weight: 500;
        }

        .status-section {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 12px;
        }

        .status-label {
            color: #b0bec5;
        }

        .status-value {
            color: #e6e6e6;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            color: #fdd835;
            font-weight: 600;
        }

        .error {
            background: rgba(244,67,54,0.2);
            color: #f44336;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid rgba(244,67,54,0.3);
        }

        .success {
            background: rgba(76,175,80,0.2);
            color: #4caf50;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid rgba(76,175,80,0.3);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SPY Gamma Flip Calculator</h1>
            <p>Institutional-Grade Options Flow Analysis | Real-Time EMA & Gamma Levels</p>
        </div>

        <div class="main-content">
            <div class="chart-container">
                <div id="status" class="loading">Initializing Gamma Flip Analysis...</div>
                <div class="chart-wrapper">
                    <div id="chartContainer"></div>
                </div>
            </div>

            <div class="sidebar">
                <div class="levels-section">
                    <h3>Current SPY Levels</h3>
                    <div id="currentLevels">
                        <div class="loading">Calculating levels...</div>
                    </div>
                </div>

                <div class="status-section">
                    <h4 style="color: #fdd835; margin-bottom: 10px;">Market Analysis</h4>
                    <div id="marketStatus">
                        <div class="status-item">
                            <span class="status-label">Current Price:</span>
                            <span class="status-value" id="currentPrice">--</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Gamma Direction:</span>
                            <span class="status-value" id="gammaDirection">--</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Gamma Strength:</span>
                            <span class="status-value" id="gammaStrength">--</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Last Update:</span>
                            <span class="status-value" id="lastUpdate">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the gamma flip engine
        import { GammaFlipEngine } from './src/math/GammaFlipEngine.js';
        import { SPYDataGenerator } from './src/data/SPYDataGenerator.js';

        class SPYGammaCalculator {
            constructor() {
                this.gammaEngine = new GammaFlipEngine();
                this.dataGenerator = new SPYDataGenerator();
                this.chart = null;
                this.candleSeries = null;
                this.currentData = null;
            }

            async initialize() {
                try {
                    this.updateStatus('Loading SPY data...', 'loading');

                    // Generate calibrated SPY data
                    this.currentData = this.dataGenerator.generateCalibratedSPYData();

                    this.updateStatus('Calculating gamma flip levels...', 'loading');

                    // Calculate gamma flip analysis
                    const analysis = this.gammaEngine.generateSPYAnalysis(this.currentData);

                    this.updateStatus('Initializing chart...', 'loading');

                    // Initialize chart
                    this.initializeChart();

                    this.updateStatus('Rendering levels...', 'loading');

                    // Display analysis
                    this.displayAnalysis(analysis);
                    this.addLevelsToChart(analysis);

                    this.updateStatus('SPY Gamma Flip Analysis Ready', 'success');

                } catch (error) {
                    console.error('Initialization error:', error);
                    this.updateStatus(`Error: ${error.message}`, 'error');
                }
            }

            initializeChart() {
                const container = document.getElementById('chartContainer');
                container.innerHTML = '';

                this.chart = LightweightCharts.createChart(container, {
                    width: container.clientWidth,
                    height: 500,
                    layout: {
                        background: { color: 'transparent' },
                        textColor: '#e6e6e6'
                    },
                    grid: {
                        vertLines: { color: 'rgba(255,255,255,0.05)' },
                        horzLines: { color: 'rgba(255,255,255,0.05)' }
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                    },
                    rightPriceScale: {
                        borderColor: 'rgba(255,255,255,0.1)',
                        textColor: '#e6e6e6',
                    },
                    timeScale: {
                        borderColor: 'rgba(255,255,255,0.1)',
                        textColor: '#e6e6e6',
                        timeVisible: true,
                        secondsVisible: false
                    }
                });

                // Add candlestick series
                this.candleSeries = this.chart.addCandlestickSeries({
                    upColor: '#26a69a',
                    downColor: '#ef5350',
                    borderVisible: false,
                    wickUpColor: '#26a69a',
                    wickDownColor: '#ef5350',
                    priceFormat: {
                        type: 'price',
                        precision: 2,
                        minMove: 0.01
                    }
                });

                this.candleSeries.setData(this.currentData);

                // Handle resize
                const resizeObserver = new ResizeObserver(entries => {
                    if (entries.length === 0 || entries[0].target !== container) return;
                    const newRect = entries[0].contentRect;
                    this.chart.applyOptions({ width: newRect.width, height: 500 });
                });
                resizeObserver.observe(container);
            }

            addLevelsToChart(analysis) {
                const colors = {
                    'gamma_flip': '#9c27b0',
                    'ema_21d': '#2196f3',
                    'ema_9d': '#4caf50',
                    'ema_50d': '#ff9800',
                    'ema_9w': '#e91e63',
                    'reversal': '#f44336'
                };

                // Add EMA levels
                this.addHorizontalLine(analysis.emaLevels['21d_EMA'], colors.ema_21d, '21d EMA', 2);

                // Parse and add range levels
                Object.entries(analysis.emaLevels).forEach(([key, range]) => {
                    if (key !== '21d_EMA' && range.includes('-')) {
                        const [low, high] = range.split('-').map(parseFloat);
                        const mid = (low + high) / 2;
                        this.addHorizontalLine(mid, colors[key.replace('d_EMA', 'd').replace('W_EMA', 'w')], key, 1);
                    }
                });

                // Add gamma flip level
                if (analysis.gammaFlip.level.includes('-')) {
                    const [low, high] = analysis.gammaFlip.level.split('-').map(parseFloat);
                    const mid = (low + high) / 2;
                    this.addHorizontalLine(mid, colors.gamma_flip, 'Gamma Flip', 2);
                }

                // Add top reversal levels
                analysis.reversalLevels.slice(0, 3).forEach((level, index) => {
                    if (level.likelihood === 'High' || level.likelihood === 'Very High') {
                        const price = level.level.includes('-') ?
                            parseFloat(level.level.split('-')[0]) :
                            parseFloat(level.level);
                        this.addHorizontalLine(price, colors.reversal, 'Reversal', 1);
                    }
                });
            }

            addHorizontalLine(price, color, label, lineWidth) {
                const lineSeries = this.chart.addLineSeries({
                    color: color,
                    lineWidth: lineWidth,
                    priceLineVisible: true,
                    lastValueVisible: true,
                    title: `${label}: ${price.toFixed(2)}`
                });

                const currentTime = Math.floor(Date.now() / 1000);
                lineSeries.setData([
                    { time: currentTime - 30 * 24 * 3600, value: price },
                    { time: currentTime + 7 * 24 * 3600, value: price }
                ]);

                return lineSeries;
            }

            displayAnalysis(analysis) {
                // Update current levels display
                const levelsHtml = `
                    <div class="level-item level-ema21">
                        <span class="level-label">21d EMA</span>
                        <span class="level-price">$${analysis.emaLevels['21d_EMA']}</span>
                    </div>
                    <div class="level-item level-gamma">
                        <span class="level-label">Gamma Flip</span>
                        <span class="level-price">$${analysis.gammaFlip.level}</span>
                    </div>
                    <div class="level-item level-ema9">
                        <span class="level-label">9d EMA</span>
                        <span class="level-price">$${analysis.emaLevels['9d_EMA']}</span>
                    </div>
                    <div class="level-item level-ema50">
                        <span class="level-label">50d EMA</span>
                        <span class="level-price">$${analysis.emaLevels['50d_EMA']}</span>
                    </div>
                    <div class="level-item level-ema9w">
                        <span class="level-label">9W EMA</span>
                        <span class="level-price">$${analysis.emaLevels['9W_EMA']}</span>
                    </div>
                    ${analysis.reversalLevels.slice(0, 3).map(level => `
                        <div class="level-item level-reversal">
                            <span class="level-label">${level.likelihood} Reversal</span>
                            <span class="level-price">$${level.level}</span>
                        </div>
                    `).join('')}
                `;

                document.getElementById('currentLevels').innerHTML = levelsHtml;

                // Update market status
                document.getElementById('currentPrice').textContent = `$${analysis.currentPrice}`;
                document.getElementById('gammaDirection').textContent = analysis.gammaFlip.direction;
                document.getElementById('gammaStrength').textContent =
                    `${(analysis.gammaFlip.strength * 100).toFixed(0)}%`;
                document.getElementById('lastUpdate').textContent =
                    new Date().toLocaleTimeString();
            }

            updateStatus(message, type = 'loading') {
                const statusEl = document.getElementById('status');
                statusEl.textContent = message;
                statusEl.className = type;
            }
        }

        // Initialize calculator when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            const calculator = new SPYGammaCalculator();
            await calculator.initialize();
        });
    </script>
</body>
</html>