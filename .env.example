# PivotQuant runtime env template
# Copy to .env and fill values as needed.

# --- Model governance / promotion ---
# Runtime candidate manifest written by training (kept out of git)
RF_CANDIDATE_MANIFEST=manifest_runtime_latest.json
# Runtime metadata manifests (relative to RF_MODEL_DIR unless absolute path)
RF_METADATA_DIR=metadata_runtime
# Active manifest served by ml_server and used by reports
RF_ACTIVE_MANIFEST=manifest_active.json
# Optional hard override (absolute/relative path) for serving/reporting manifest
# RF_MANIFEST_PATH=data/models/manifest_active.json
# Governance gates
MODEL_GOV_REQUIRED_TARGETS=reject,break
MODEL_GOV_REQUIRED_HORIZONS=5,15,60
MODEL_GOV_MIN_TRAINED_END_DELTA_MS=0
MODEL_GOV_MAX_MFE_REGRESSION_BPS=1.5
MODEL_GOV_MAX_MAE_WORSENING_BPS=2.0
# Optional support thresholds for MAE/MFE regression gates.
# Gates are skipped for a target/horizon when support is below these floors.
# Keep 0 to disable support-aware skipping.
MODEL_GOV_MIN_TOTAL_SAMPLES=0
MODEL_GOV_MIN_POSITIVE_SAMPLES=0
# Optional per-target overrides (fall back to MODEL_GOV_MIN_POSITIVE_SAMPLES).
MODEL_GOV_MIN_POSITIVE_SAMPLES_REJECT=0
MODEL_GOV_MIN_POSITIVE_SAMPLES_BREAK=0
MODEL_GOV_ALLOW_FEATURE_VERSION_CHANGE=false
# Emergency override: force promotion even if gates fail
MODEL_GOV_FORCE_PROMOTE=false

# ML scoring horizons treated as "shadow" (scored/reported but excluded from best_horizon signal selection).
ML_SHADOW_HORIZONS=30

# Run lightweight ops smoke tests automatically before each retrain cycle.
# If tests fail, retrain aborts and sends immediate alert via ML_ALERT channels.
ML_RUN_OPS_SMOKE_ON_RETRAIN=true

# --- Public dashboard sharing hardening (Tailscale Funnel / internet exposure) ---
# Enable password-only dashboard auth at the proxy (:3000).
# Recommended when exposing the host publicly.
DASH_AUTH_ENABLED=false
DASH_AUTH_PASSWORD=
# Optional login page text.
DASH_AUTH_PAGE_TITLE=PivotQuant Dashboard Access
DASH_AUTH_PAGE_SUBTITLE=Enter password to continue.
# Session cookie controls.
DASH_AUTH_COOKIE_NAME=pq_dash_auth
DASH_AUTH_COOKIE_TTL_SEC=2592000
# Apply Secure flag only on HTTPS requests when true.
DASH_AUTH_COOKIE_SECURE=true
# Allow localhost requests (launchd/scripts on host) without auth.
DASH_AUTH_LOCAL_BYPASS=true
# Restrict mutation endpoints (/api/bars,/api/events,/api/ml/score,/api/ml/reload)
# to local requests only. Keep true for public sharing.
DASH_WRITE_ENDPOINTS_LOCAL_ONLY=true
# Browser CORS allowlist used by local HTTP services (:5001/:5002/:5004) and ml_server.
ML_CORS_ORIGINS=http://127.0.0.1:3000,http://localhost:3000
# Max events accepted per /api/ml/score batch request.
ML_SCORE_MAX_BATCH_EVENTS=256
# Audit retention for ops_audit_events (days). Prune runs as contiguous
# prefix cleanup to preserve tamper-evident chain verification.
ML_AUDIT_RETENTION_DAYS=90
# Minimum interval between automatic audit prune runs (milliseconds).
# 86400000 = once per day.
ML_AUDIT_PRUNE_INTERVAL_MS=86400000

# --- Daily report notifications ---
# Comma-separated channels: email,imessage,webhook
ML_REPORT_NOTIFY_CHANNELS=email

# If true, retrain cycle (every 6h) sends notifications too.
# Keep false if using scheduled daily LaunchAgent to avoid spam.
ML_REPORT_NOTIFY_ON_RETRAIN=false
ML_REPORT_EMAIL_STYLE=compact
ML_REPORT_ANOMALY_LIMIT=6
# Auto-failover when email fails with Gmail auth/rate-limit errors (535/550)
ML_REPORT_FAILOVER_CHANNELS=webhook,imessage

# --- Immediate health alerts (ML / collector downtime) ---
# Default behavior: notify only on state transitions (DOWN, RECOVERED)
ML_ALERT_NOTIFY_CHANNELS=email
# Optional override recipient list (falls back to ML_REPORT_EMAIL_TO)
# ML_ALERT_EMAIL_TO=you@example.com
# Optional override sender (falls back to ML_REPORT_EMAIL_FROM)
# ML_ALERT_EMAIL_FROM=you@example.com
# Health endpoints to watch
ML_ALERT_ML_HEALTH_URL=http://127.0.0.1:5003/health
ML_ALERT_COLLECTOR_HEALTH_URL=http://127.0.0.1:5004/health
# LaunchAgent check frequency (seconds)
ML_ALERT_CHECK_INTERVAL_SEC=60
# Health request timeout per endpoint (seconds)
ML_ALERT_TIMEOUT_SEC=4
# Re-alert while still down (minutes). 0 = disabled (transition-only alerts)
ML_ALERT_REPEAT_MIN=0
# Subject prefixes
ML_ALERT_SUBJECT_PREFIX=[ALERT]
ML_ALERT_RECOVERY_PREFIX=[RECOVERED]
# Auto-failover when email fails with Gmail auth/rate-limit errors (535/550)
ML_ALERT_FAILOVER_CHANNELS=webhook,imessage

# --- Session routine checks (scheduled ET pre-open + post-open snapshots) ---
# LaunchAgent loop cadence (seconds). The checker itself gates by ET windows.
ML_SESSION_ROUTINE_INTERVAL_SEC=300
# ET reference timezone for schedule windows
ML_SESSION_ET_TZ=America/New_York
# Target windows in ET
ML_SESSION_PREOPEN_HOUR=9
ML_SESSION_PREOPEN_MINUTE=20
ML_SESSION_POSTOPEN_HOUR=9
ML_SESSION_POSTOPEN_MINUTE=40
# Allow N-minute execution window after each target minute
ML_SESSION_WINDOW_MIN=10
# Send OK summaries as well (true = two daily routine updates)
ML_SESSION_NOTIFY_ON_OK=true
# Optional per-phase overrides
# ML_SESSION_PREOPEN_NOTIFY_ON_OK=true
# ML_SESSION_POSTOPEN_NOTIFY_ON_OK=true
# Post-open flow thresholds (lookback window)
ML_SESSION_LOOKBACK_MIN=15
ML_SESSION_POSTOPEN_MIN_BARS=1
ML_SESSION_POSTOPEN_MIN_EVENTS=0
ML_SESSION_POSTOPEN_MIN_LIVE_PREDS=0
# Optional endpoints
ML_SESSION_OPS_STATUS_URL=http://127.0.0.1:3000/api/ops/status
ML_SESSION_GAMMA_URL=http://127.0.0.1:5001/gamma?symbol=SPY&expiry=front&limit=10
# Subject prefix for non-failing routine checks
ML_SESSION_CHECK_PREFIX=[CHECK]

# Optional scheduled-delivery time overrides (Mac local time)
# ML_REPORT_MORNING_HOUR=8
# ML_REPORT_MORNING_MINUTE=5
# ML_REPORT_CLOSE_HOUR=17
# ML_REPORT_CLOSE_MINUTE=10
# Lock/dedupe controls for report sender
# ML_REPORT_LOCK_WAIT_SEC=120
# ML_REPORT_FORCE_SEND=false
# Optional report date override controls:
# ML_REPORT_REPORT_DATE=2026-02-17
# ML_REPORT_REPORT_DATE_MODE=auto
# Modes: auto | et_today | latest_completed

# Email (SMTP)
ML_REPORT_EMAIL_TO=you@example.com
ML_REPORT_EMAIL_FROM=you@example.com
ML_REPORT_SMTP_HOST=smtp.gmail.com
ML_REPORT_SMTP_PORT=587
ML_REPORT_SMTP_USER=you@example.com
ML_REPORT_SMTP_PASS=replace_with_app_password
ML_REPORT_SMTP_USE_TLS=true

# Include runtime log tails in email body.
ML_REPORT_INCLUDE_LOG_TAILS=true
ML_REPORT_LOG_TAIL_LINES=80
# Optional cost model for impact section (bps)
ML_COST_SPREAD_BPS=0.8
ML_COST_SLIPPAGE_BPS=0.4
ML_COST_COMMISSION_BPS=0.1
# Threshold tuning objective for retrain/calibration:
# utility_bps optimizes expected net bps (direction-aware, after costs).
# Set to f1 if you need a pure classification objective instead.
RF_THRESHOLD_OBJECTIVE=utility_bps
CALIB_REFIT_THRESHOLD_OBJECTIVE=utility_bps
# Session-aware staleness thresholds (US regular session hours, ET)
# 13.0h ~= 2 sessions, 19.5h ~= 3 sessions
ML_STALENESS_WARN_SESSION_HOURS=13
ML_STALENESS_KILL_SESSION_HOURS=19.5
# Daily report horizons to render (must match prediction_log signal/prob columns).
ML_REPORT_HORIZONS=5,15,30,60
# Gamma enrichment for event generation (optional, IBKR bridge)
GAMMA_BRIDGE_URL=http://127.0.0.1:5001/gamma
# IV/RV regime thresholds for iv_rv_state:
# 1 when IV/RV >= high, -1 when IV/RV <= low, else 0
GAMMA_IV_RV_HIGH_RATIO=1.15
GAMMA_IV_RV_LOW_RATIO=0.85
# Optional override list (comma-separated absolute paths):
# ML_REPORT_LOG_FILES=/Users/you/PIVOT_QUANT/logs/retrain.log,/Users/you/PIVOT_QUANT/logs/ml_server.log

# Live collector gamma polling resilience
# Keep gamma snapshot fresh every N seconds when healthy.
LIVE_COLLECTOR_GAMMA_REFRESH_SEC=300
# If gamma bridge is unavailable (e.g., missing IBKR options permissions),
# back off retries to avoid noisy repeated errors.
LIVE_COLLECTOR_GAMMA_RETRY_SEC=1800

# Export level-conversion endpoint cache (SPY -> S&P500 / US500)
LEVEL_CONVERTER_SNAPSHOT_TTL_MS=60000
LEVEL_CONVERTER_RESULT_TTL_MS=30000
LEVEL_CONVERTER_CACHE_MAX_SIZE=120

# iMessage (optional, comma-separated recipients)
# ML_REPORT_IMESSAGE_TO=+15551234567
# Optional dedicated alert iMessage recipients
# ML_ALERT_IMESSAGE_TO=+15551234567

# Webhook (optional)
# ML_REPORT_WEBHOOK_URL=https://example.com/webhook
# Optional dedicated alert webhook
# ML_ALERT_WEBHOOK_URL=https://example.com/alert-webhook

# --- Ops resilience: backups / drills / host checks ---
# Backup destination root
PIVOT_BACKUP_ROOT=/Users/tristanalejandro/PIVOT_QUANT/backups
# Shared lock file to prevent overlapping backup/drill runs
PIVOT_OPS_LOCK_FILE=/Users/tristanalejandro/PIVOT_QUANT/logs/ops_resilience.lock
# Wait time before skipping when lock is busy
PIVOT_OPS_LOCK_TIMEOUT_SEC=300
# Retention (effective): newest N daily snapshots + one snapshot per ISO week for W weeks
BACKUP_DAILY_KEEP=30
BACKUP_WEEKLY_KEEP=8
# LaunchAgent schedule (Mac local time)
BACKUP_HOUR=22
BACKUP_MINUTE=20
# Weekly restore drill schedule (weekday: 0=Sunday, 1=Monday, ... 6=Saturday)
RESTORE_DRILL_WEEKDAY=0
RESTORE_DRILL_HOUR=23
RESTORE_DRILL_MINUTE=0
# Host health check cadence (seconds)
HOST_HEALTH_CHECK_INTERVAL_SEC=900
# Host health thresholds
HOST_HEALTH_DISK_WARN_PCT=15
HOST_HEALTH_DISK_CRIT_PCT=8
# Ignore DB growth alerts while DB is still tiny
HOST_HEALTH_DB_GROWTH_MIN_MB=256
HOST_HEALTH_DB_GROWTH_WARN_MB=2048
HOST_HEALTH_DB_GROWTH_CRIT_MB=4096
HOST_HEALTH_RESTART_WARN_DELTA=20
